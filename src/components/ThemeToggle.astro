---
import { Icon } from 'astro-icon/components';
---

<button id="theme-toggle" class="theme-toggle" type="button" aria-pressed="false">
	<span class="icon sun" aria-hidden="true">
		<Icon name="carbon:light" width="18" height="18" />
	</span>
	<span class="icon moon" aria-hidden="true">
		<Icon name="carbon:moon" width="18" height="18" />
	</span>
</button>

<script>
	const root = document.documentElement;
	const toggle = document.getElementById('theme-toggle');

	if (toggle) {
		const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
		const applyTheme = (theme, persist = false) => {
			root.dataset.theme = theme;
			toggle.dataset.theme = theme;
			toggle.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
			const nextLabel = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
			toggle.setAttribute('aria-label', nextLabel);
			if (persist) {
				localStorage.setItem('theme', theme);
			}
		};

		const stored = localStorage.getItem('theme');
		const initialTheme = stored ?? (prefersDark.matches ? 'dark' : 'light');
		applyTheme(initialTheme);

		toggle.addEventListener('click', () => {
			const nextTheme = root.dataset.theme === 'dark' ? 'light' : 'dark';
			applyTheme(nextTheme, true);
		});

		const handleMediaChange = (event) => {
			if (localStorage.getItem('theme')) return;
			applyTheme(event.matches ? 'dark' : 'light');
		};

		if (prefersDark.addEventListener) {
			prefersDark.addEventListener('change', handleMediaChange);
		} else if (prefersDark.addListener) {
			prefersDark.addListener(handleMediaChange);
		}
	}
</script>

<style>
	.theme-toggle {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		gap: 0;
		padding: 0.25em;
		border-radius: 6px;
		border: none;
		background: transparent;
		color: rgb(var(--black));
		cursor: pointer;
		box-shadow: none;
		transition: color 0.2s ease, background-color 0.2s ease;
	}
	.theme-toggle:hover {
		color: var(--accent);
		background-color: rgba(var(--accent), 0.08);
	}
	.theme-toggle:focus-visible {
		outline: 2px solid var(--accent);
		outline-offset: 2px;
	}
	.theme-toggle .icon {
		display: none;
		align-items: center;
		justify-content: center;
		transition: opacity 0.2s ease, transform 0.2s ease;
	}
	.theme-toggle[data-theme='light'] .sun {
		display: inline-flex;
	}
	.theme-toggle[data-theme='dark'] .moon {
		display: inline-flex;
	}
</style>
